---
title: "04_cape_cin"
author: "Pao"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(metR)
library(aiRthermo)
library(reticulate)

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")
```

# An치lisis 

Quermeos comparar los experimentos E3 que asimila el prepbufr nivel 3 (oficiales + autom치ticas) y el E4 que solo asimila prepbufr nivel 1. Por ahora nos vamos a concentrar en la media del a치lisis.

## CAPE y CIN

```{r read}
path <- "E3/ANA/20181122060000/analysis.ensmean"

# file_test <- ReadNetCDF(path, vars = c(lon = "XLONG", lat = "XLAT", "P", "PB", "T", "QVAPOR")) %>%
#   .[, P := P + PB] %>%
#   .[, T := (T + 290)*(P/100000)^(2/7)] %>%
#   .[, c("Time", "south_north", "west_east", "PB") := NULL]

file_test <- ReadNetCDF(path, vars = c("P", "PB", "T", "QVAPOR"), subset = list(south_north = 105:107)) %>%
  .[, P := P + PB] %>%
  .[, T := (T + 290)*(P/100000)^(2/7)] %>%
  .[, c("PB") := NULL]

capear <- function(p, t, q) {
  # browser()
  cape <- CAPE_CIN(p, t, q)
  
  list(cape = cape$cape,
       cin = cape$cin,
       outCode = cape$outCode)
  
}

cape <- file_test[, capear(P, T, QVAPOR), by = .(south_north, west_east)]


cape[] %>% 
  ggplot(aes(west_east, south_north)) +
  geom_point(aes(color = cape)) +
  scale_color_viridis_c() +
  coord_equal()

```


```{r}
library(patchwork)
cape <- fread("analisis/cape_cin_ana_E3.csv") %>% 
  .[, date := lubridate::ymd_hms(date)]

cape[, .(mean_cape = mean(cape)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cape), breaks = seq(500, 4000, 500)) +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       breaks = seq(500, 4000, 500),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(title = "CONV Only",
       subtitle = "CAPE") +
  coord_cartesian(xlim = c(0, 200)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_datetime(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
cape[, .(mean_cin = mean(cin)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cin), breaks = seq(-500, -10, 50)) +
  scale_fill_distiller(name = NULL, palette = "YlGnBu", direction = -1,
                       breaks = seq(-500, -10, 50),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(subtitle = "CIN") +
  coord_cartesian(xlim = c(0, 200)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_datetime(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
library(patchwork)
cape <- fread("analisis/cape_cin_ana_E4.csv") %>% 
  .[, date := lubridate::ymd_hms(date)]

cape[, .(mean_cape = mean(cape)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cape), breaks = seq(500, 4000, 500)) +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       breaks = seq(500, 4000, 500),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(title = "CONV Only",
       subtitle = "CAPE") +
  coord_cartesian(xlim = c(0, 200)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_datetime(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
cape[, .(mean_cin = mean(cin)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cin), breaks = seq(-500, -10, 50)) +
  scale_fill_distiller(name = NULL, palette = "YlGnBu", direction = -1,
                       breaks = seq(-500, -10, 50),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(subtitle = "CIN") +
  coord_cartesian(xlim = c(0, 200)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_datetime(expand = c(0,0)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
E3 <- fread("analisis/cape_cin_ana_E3.csv") %>% # Experimento bueno
  .[, date := lubridate::ymd_hms(date)] %>% 
  .[, .(cape = mean(cape),
        cin = mean(cin)), by = .(west_east, date)]

E4 <- fread("analisis/cape_cin_ana_E4.csv") %>% # Experimento malo
  .[, date := lubridate::ymd_hms(date)] %>% 
  .[, .(cape = mean(cape),
        cin = mean(cin)), by = .(west_east, date)]

E4[E3, on = c("west_east", "date")] %>% 
  .[, `:=`(diff_cape = i.cape - cape,
           diff_cin = i.cin - cin)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = diff_cin)) +
  # geom_contour2(aes(z = diff_cin)) +
  scale_fill_divergent(name = "Difference") +
  labs(title = "CAPE difference",
       subtitle = "E1 - E3") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_datetime(expand = c(0,0)) +
  theme_minimal()
    

```

```{r}
E3 <- fread("analisis/cape_cin_espacial_ana_E3.csv") %>% 
  .[, `:=`(date = lubridate::ymd_hms(date),
           exp = "E3")]
E4 <- fread("analisis/cape_cin_espacial_ana_E4.csv") %>% 
  .[, `:=`(date = lubridate::ymd_hms(date),
           exp = "E4")]
rbind(E3, E4) %>% 
  ggplot(aes(west_east, south_north)) +
  geom_contour_fill(aes(z = cape), breaks = seq(500, 5000, 500)) +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       breaks = seq(500, 5000, 500),
                       guide = guide_colorstrip(barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(exp ~ factor(date)) +
  theme_minimal() +
  theme(legend.position = "bottom")

```


## Temperatura y humedad

Perfiles de temperatura y humedad promediados en todo el dominio

```{r}
perfil_E3 <- fread("analisis/perfil_T_Q_ana_E3.csv") %>% 
  .[, date := lubridate::ymd_hms(date)] 

perfil_E4 <- fread("analisis/perfil_T_Q_ana_E4.csv") %>% 
  .[, date := lubridate::ymd_hms(date)]

perfil_E4[perfil_E3, on = c("bottom_top", "date")] %>%
  .[] %>% 
  .[, `:=`(diff_T = i.T - T,
           diff_Q = i.QVAPOR - QVAPOR)] %>% 
  ggplot(aes(date, bottom_top)) +
  geom_contour_fill(aes(z = diff_T)) +
  scale_fill_divergent(name = "Difference") +
  labs(title = "Temperature difference",
       subtitle = "E1 - E2") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_datetime(expand = c(0,0)) +
  theme_minimal()

perfil_E4[perfil_E3, on = c("bottom_top", "date")] %>%
  .[] %>% 
  .[, `:=`(diff_T = i.T - T,
           diff_Q = i.QVAPOR - QVAPOR)] %>% 
  ggplot(aes(date, bottom_top)) +
  geom_contour_fill(aes(z = diff_Q)) +
  scale_fill_divergent(name = "Difference") +
  labs(title = "Humidity difference",
       subtitle = "E1 - E2") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_datetime(expand = c(0,0)) +
  theme_minimal()
```

## Circulaci칩n

```{r}
ana_2121 <- ReadNetCDF("analisis/u_20181121210000_E3.nc", vars = c(u = "uvmet")) %>% 
  .[, v := ReadNetCDF("analisis/v_20181121210000_E3.nc", vars = c(v = "uvmet"), out = "vector")] %>% 
  .[, t := ReadNetCDF("analisis/t_20181121210000_E3.nc",  vars = c(t = "temp"), out = "vector")]

ana_2121[bottom_top == 10] %>% 
  ggplot(aes(west_east, south_north)) +
  geom_point(aes(color = t - 273)) +
  geom_vector(aes(dx = u, dy = v), data = function(x) x[is.cross(west_east, south_north, 2)]) +
  scale_mag()
```

