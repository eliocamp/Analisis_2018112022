---
title: "04_cape_cin"
author: "Pao"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(metR)
library(aiRthermo)
library(reticulate)

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")
```

## Análisis de CAPE y CIN

Quermeos comparar los experimentos E3 que asimila el prepbufr nivel 3 (oficiales + automáticas) y el E4 que solo asimila prepbufr nivel 1. Por ahora nos vamos a concentrar en la media del aálisis.

```{r read}
path <- "E3/ANA/20181122060000/analysis.ensmean"

# file_test <- ReadNetCDF(path, vars = c(lon = "XLONG", lat = "XLAT", "P", "PB", "T", "QVAPOR")) %>%
#   .[, P := P + PB] %>%
#   .[, T := (T + 290)*(P/100000)^(2/7)] %>%
#   .[, c("Time", "south_north", "west_east", "PB") := NULL]

file_test <- ReadNetCDF(path, vars = c("P", "PB", "T", "QVAPOR"), subset = list(south_north = 105:107)) %>%
  .[, P := P + PB] %>%
  .[, T := (T + 290)*(P/100000)^(2/7)] %>%
  .[, c("PB") := NULL]

capear <- function(p, t, q) {
  # browser()
  cape <- CAPE_CIN(p, t, q)
  
  list(cape = cape$cape,
       cin = cape$cin,
       outCode = cape$outCode)
  
}

cape <- file_test[, capear(P, T, QVAPOR), by = .(south_north, west_east)]


cape[] %>% 
  ggplot(aes(west_east, south_north)) +
  geom_point(aes(color = cape)) +
  scale_color_viridis_c() +
  coord_equal()

```


```{r}
library(patchwork)
cape <- fread("analisis/cape_cin_ana_E3.csv") %>% 
  .[, date := lubridate::ymd_hms(date)]

cape[, .(mean_cape = mean(cape)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cape), breaks = seq(500, 4000, 500)) +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       breaks = seq(500, 4000, 500),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(title = "CONV Only",
       subtitle = "CAPE") +
  coord_cartesian(xlim = c(0, 200)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
cape[, .(mean_cin = mean(cin)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cin), breaks = seq(-500, -10, 50)) +
  scale_fill_distiller(name = NULL, palette = "YlGnBu", direction = -1,
                       breaks = seq(-500, -10, 50),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(subtitle = "CIN") +
  coord_cartesian(xlim = c(0, 200)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
library(patchwork)
cape <- fread("analisis/cape_cin_ana_E4.csv") %>% 
  .[, date := lubridate::ymd_hms(date)]

cape[, .(mean_cape = mean(cape)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cape), breaks = seq(500, 4000, 500)) +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       breaks = seq(500, 4000, 500),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(title = "CONV Only",
       subtitle = "CAPE") +
  coord_cartesian(xlim = c(0, 200)) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  
cape[, .(mean_cin = mean(cin)), by = .(west_east, date)] %>% 
  ggplot(aes(west_east, date)) +
  geom_contour_fill(aes(z = mean_cin), breaks = seq(-500, -10, 50)) +
  scale_fill_distiller(name = NULL, palette = "YlGnBu", direction = -1,
                       breaks = seq(-500, -10, 50),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(subtitle = "CIN") +
  coord_cartesian(xlim = c(0, 200)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```