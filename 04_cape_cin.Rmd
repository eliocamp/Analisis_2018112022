---
title: "04_Analisis"
author: "Pao"
date: "11/11/2019"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(data.table)
library(metR)
library(aiRthermo)
library(reticulate)

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

geom_mapa <- function() {
  geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE)
}

# coord <- ReadNetCDF("analysis.ensmean", 
#                     vars = c(lon = "XLONG", lat = "XLAT")) %>% 
#   .[, Time := NULL]

# ReadNetCDF("E3/ANA/20181122060000/analysis.ensmean", vars = c("P", "PB")) %>% 
#   .[, P := (P + PB)/100] %>% 
#   .[P %between% c(898, 902)] %>% 
#   .[] %>% 
#   ggplot(aes(bottom_top)) +
#   geom_density()
```

# An치lisis 

Quermeos comparar los experimentos E3 que asimila el prepbufr nivel 3 (oficiales + autom치ticas) y el E4 que solo asimila prepbufr nivel 1. Por ahora nos vamos a concentrar en la media del a치lisis.

## CAPE y CIN

```{r read, include=FALSE}
files <- list.files("mucape", full.names = TRUE)

cape <- lapply(files, function(file) {
  details <- unglue::unglue(file, "mucape/mcape_ana_{exp}_{date}.nc")[[1]]
  
  ReadNetCDF(file, vars = c(value = "cape_2d")) %>% 
    .[, `:=`(exp = details$exp, 
             date = lubridate::ymd_hms(details$date))] %>%
    setnames(old = "mcape_mcin_lcl_lfc", new = "variable") %>% 
    .[]
}) %>% 
  rbindlist() %>% 
  .[variable == "mcape"]

coord <- ReadNetCDF(files[1], vars = c(lon = "XLONG")) %>% 
  .[, lat := ReadNetCDF(files[1], vars = c(lat = "XLAT"))$lat]

```


```{r}
south_north_band <- c(105, 109)
library(patchwork)

cape %>% 
  .[south_north %between% south_nort_band, .(mean_cape = mean(value, na.rm = TRUE)), by = .(date, west_east, exp)] %>%
  # dcast(date + west_east ~ exp, value.var = "mean_cape") %>% 
  .[coord[south_north %~% mean(south_north_band)], on = .NATURAL] %>% 
  ggplot(aes(lon, date)) +
  geom_contour_fill(aes(z = mean_cape), breaks = seq(500, 4000, 500), na.fill = 0) +
  geom_contour2(data = function(d) dcast(d, date + lon ~ exp, value.var = "mean_cape")[, dif := E3 - E4],
    aes(z = dif), breaks = seq(500, 4000, 500), na.fill = 0) +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       breaks = seq(500, 4000, 500),
                       guide = guide_colorstrip(barwidth = 15,
                                                barheight = 0.8)) +
  labs(title = "MCAPE") +
  scale_x_longitude(ticks = 2.5, expand = c(0,0)) +
  scale_y_datetime("Time", expand = c(0,0)) +
  facet_grid(~exp, labeller = labeller(exp = c(E3 = "CONV+AUT", E4 = "CONV"))) +
  theme_minimal() +
  theme(legend.position = "bottom", panel.ontop = TRUE) 
```


```{r}


interpol <- function(x, y, z, ...) {
  IL <- interp::interp(x, y, z, ...)
  CJ(y = IL$y, x = IL$x)[, z := c(IL$z)] 
}

cape[date %in% ymd_h(c("2018-11-21 21", 
                       "2018-11-22 00",
                       "2018-11-22 06", 
                       "2018-11-22 03"))] %>% 
  .[coord, on = .NATURAL] %>% 
  .[!is.finite(value), value := 0] %>% 
  .[, interpol(lon, lat, value, nx = 50, ny = 50), by = .(date, exp)] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "value")) %>%
  na.omit() %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = round(value, 6)), na.fill = 0) +
  # geom_contour2(data = function(d) dcast(d, lat + lon + date ~ exp, value.var = "value")[, dif := E3 - E4],
  #   aes(z = dif), bins = 5)+
  geom_mapa() +
  scale_fill_distiller(name = NULL, palette = "YlOrRd", direction = 1, 
                       # breaks = seq(500, 5000, 500),
                       guide = guide_colorstrip(barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(exp ~ date) +
  coord_sf(xlim = range(coords$lon), ylim = range(coords$lat)) +
  theme_minimal() +
  theme(legend.position = "bottom", panel.ontop = TRUE) 
```



## Temperatura y humedad

Perfiles de temperatura y humedad promediados en todo el dominio

```{r}
perfil_E3 <- fread("analisis/perfil_T_Q_ana_E3.csv") %>% 
  .[, date := ymd_hms(date)] 

perfil_E4 <- fread("analisis/perfil_T_Q_ana_E4.csv") %>% 
  .[, date := ymd_hms(date)]

perfil_E4[perfil_E3, on = c("bottom_top", "date")] %>%
  .[] %>% 
  .[, `:=`(diff_T = i.T - T,
           diff_Q = i.QVAPOR - QVAPOR)] %>% 
  ggplot(aes(date, bottom_top)) +
  geom_contour_fill(aes(z = diff_T)) +
  scale_fill_divergent(name = "Difference") +
  labs(title = "Temperature difference",
       subtitle = "E1 - E2") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_datetime(expand = c(0,0)) +
  theme_minimal()

perfil_E4[perfil_E3, on = c("bottom_top", "date")] %>%
  .[] %>% 
  .[, `:=`(diff_T = i.T - T,
           diff_Q = i.QVAPOR - QVAPOR)] %>% 
  ggplot(aes(date, bottom_top)) +
  geom_contour_fill(aes(z = diff_Q)) +
  scale_fill_divergent(name = "Difference") +
  labs(title = "Humidity difference",
       subtitle = "E1 - E2") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_datetime(expand = c(0,0)) +
  theme_minimal()
```

## Circulaci칩n

```{r}
fcsts <- expand_grid(fcsts = c("20181121210000", "20181122000000", "20181122030000", "20181122060000"),
                     exp = c("E3", "E4"))

temp_spd <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0("analisis/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, t := ReadNetCDF(paste0("analisis/t_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"),  vars = c(t = "temp"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

temp_spd[bottom_top == 7] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = t - 273)) +
  scale_color_distiller("Temperature", palette = "RdBu", direction = -1) +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, size = 0.2) +
  coord_sf(ylim = c(-41, -20), xlim = c(-75, -52.5)) +
  geom_vector(aes(dx = u, dy = v), data = function(x) x[is.cross(lon, lat, 4)]) +
  scale_mag() +
  facet_grid(exp ~ date) +
  theme_minimal() +
  metR:::theme_field()
```

## Humedad en niveles bajos

```{r}


q <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/q_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(q = "QVAPOR")) %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

q[bottom_top <= 7, .(q = mean(q)), by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = q)) +
  scale_color_distiller(palette = "BrBG", direction = 1) +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, size = 0.2) +
  coord_sf(ylim = c(-41, -20), xlim = c(-75, -52.5)) +
  facet_grid(exp ~ date) +
  theme_minimal() +
  metR:::theme_field()

```
