---
title: "103_sondeos_RELAMPAGO"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(metR)
library(data.table)
library(tidyverse)
library(lubridate)
source("help_functions.R")
source("postprocesamiento.R")
```

```{r}
files <- list.files(path = "/home/paola.corrales/datosmunin/DA/DA_DATA/OBS_RELAMPAGO/sondeos_raw",
                    pattern = "cls", full.names = TRUE)

sondeos <- purrr::map(files, ~ read_radiosonde_relampago(.x)) %>% 
  rbindlist()
```

Hay 129 sondeos entre las 18Z del 20/11 y las 12Z del 23/11!

```{r}
sondeos %>% 
  unique(by = c("launch_time", "site")) %>% 
  .[, .N, by = site] %>% 
  knitr::kable()
```

## Intento de interpolación

```{r}
ncfile <- "/home/paola.corrales/datosmunin/EXP/E4/ANA/20181120180000/analysis.mem001"

fcst <- ReadNetCDF(ncfile, vars = c(p = "P", "PB", t = "T", qv = "QVAPOR", 
                                    lon = "XLONG", lat = "XLAT")) %>%
  .[, p := p + PB] %>%
  .[, t := tk(t, p)] %>%
  .[, rh := rh(qv, p, t)] %>% 
  .[, td := td(qv, p) + 273.15] %>% 
  .[, ":="(Time = NULL,
           west_east = NULL,
           south_north = NULL,
           qv = NULL,
           PB = NULL)] %>% 
  .[, c("u", "v") := uvmet(ncfile)] %>% 
  .[, time := lubridate::ymd_hms("20181120180000")] %>% 
  .[]

```

```{r}
fcst_time <- lubridate::ymd_hms("20181120180000")

intervalo <- interval(fcst_time - minutes(5), fcst_time + minutes(5))

subset <- sondeos[launch_time %within% intervalo]


unique_subset <- subset %>% unique(by = c("lat", "lon"))

fcst_obs <- fcst %>% 
  melt(id.vars = c("bottom_top", "lon", "lat", "time")) %>% 
  .[, interp::interp(lon, lat, value, 
                     xo = unique_subset$lon, yo = unique_subset$lat,
                     output = "points"), by = .(bottom_top, variable, time)]

a <- fcst_obs[variable != "p"] %>% 
  .[fcst_obs[variable == "p"], on = c("bottom_top", "time", "x", "y")] %>% 
  setnames(c("x", "y", "z", "i.z"), c("lon", "lat", "value", "p"))

approx_safe <- purrr::possibly(approx, otherwise = NA)

b <- subset %>% 
  melt(measure.vars = c("t", "td", "rh", "u", "v")) %>% 
  .[, fcst_value := approx_safe(x = a[lon == .BY$lon & lat == .BY$lat & 
                                   variable == .BY$variable]$p*0.01, 
                           y = a[lon == .BY$lon & lat == .BY$lat & 
                                   variable == .BY$variable]$value,
                           xout = p)$y, 
    by = .(lon, lat, variable)]

b[variable %in% c("t", "td"), fcst_value := fcst_value -273.15] %>% 
  ggplot(aes(value, fcst_value)) +
  geom_point(aes(color = launch_time)) +
  geom_abline(intercept = 0, slope = 1) + 
  # coord_equal() +
  facet_wrap(~ variable, scales = "free") 

# Filtro por tiempo (10minutos alrededor del fcst)
# unique latlon (cada sondeo tiene una ubicación única), me quedan como máximo 10 puntos
# interp(lat.sonde, lon.sonde, lat.fcst, lat.fcst, z.fcst) by = (nivel, variable) --> eso me devuelve un dataframe con cant.sondeos x niveles x variables. 
# Ahora interpolación en la vertical. approx(x = p.fcst, y = var.fcst, xout = p.sondeo)
```


```{r eval=FALSE, include=FALSE}
library(reticulate)

wrf <- import("wrf")
ncdf <- import("netCDF4")

fcst1 <-  ncdf$Dataset(ncfile)

image(wrf$getvar(fcst1, "uvmet", meta = FALSE)[2, 1, , ])


T <- wrf$getvar(fcst1, "tk" , meta = FALSE)

TD <- wrf$getvar(fcst1, "td", meta = FALSE)
```

