---
title: "103_sondeos_RELAMPAGO"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(metR)
library(data.table)
library(tidyverse)
library(lubridate)
source("help_functions.R")
```

```{r}
files <- list.files(path = "/home/paola.corrales/datosmunin/DA/DA_DATA/OBS_RELAMPAGO/sondeos_raw",
                    pattern = "cls", full.names = TRUE)

sondeos <- purrr::map(files, ~ read_radiosonde_relampago(.x)) %>% 
  rbindlist()

```

Hay 129 sondeos entre las 18Z del 20/11 y las 12Z del 23/11!

```{r}
sondeos %>% 
  unique(by = c("Launch_time", "Site")) %>% 
  .[, .N, by = Site] %>% 
  knitr::kable()
```

## Intento de interpolaci√≥n

```{r}
ncfile <- "/home/paola.corrales/datosmunin/EXP/E4/ANA/20181120180000/analysis.mem001"

fcst <- ReadNetCDF(ncfile, vars = c("P", "PB", "T", "QVAPOR", 
                                    lon = "XLONG", lat = "XLAT")) %>%
    .[, P := P + PB] %>%
    .[, T := TK(T, P)] %>%
    .[, RH := rh(QVAPOR, P, T)] %>% 
    .[, DEWP := td(QVAPOR, P) + 273.15] %>% 
    .[, ":="(west_east = NULL,
             bottom_top = NULL,
             south_north = NULL,
             PB = NULL)] %>% 
  .[]

```

```{r}
library(reticulate)

wrf <- import("wrf")
ncdf <- import("netCDF4")

fcst1 <-  ncdf$Dataset(ncfile)

T <- wrf$getvar(fcst1, "tk" , meta = FALSE)

TD <- wrf$getvar(fcst1, "td", meta = FALSE)
```

